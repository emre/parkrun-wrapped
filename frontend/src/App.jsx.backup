import { useState, useEffect } from 'react'
import axios from 'axios'
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar } from 'recharts'
import './App.css'
import './Story.css'

function App() {
  const [parkrunId, setParkrunId] = useState('8604987')
  const [data, setData] = useState(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState(null)
  const [showStory, setShowStory] = useState(false)
  const [currentSlide, setCurrentSlide] = useState(0)
  const [autoPlay, setAutoPlay] = useState(true)

  const fetchData = async () => {
    setLoading(true)
    setError(null)
    try {
      const response = await axios.get(`http://localhost:3001/api/parkrunner/${parkrunId}`)
      setData(response.data)
      setShowStory(true) // Auto-start story when data loads
      setCurrentSlide(0)
    } catch (err) {
      setError('Failed to fetch parkrun data. Make sure the backend server is running.')
      console.error(err)
    } finally {
      setLoading(false)
    }
  }

  const processTimeData = () => {
    if (!data?.runs) return []
    
    return data.runs.slice(0, 20).reverse().map((run, index) => {
      const timeParts = run.time.split(':')
      const totalSeconds = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1])
      return {
        date: run.date,
        time: totalSeconds,
        formattedTime: run.time,
        position: parseInt(run.position) || 0
      }
    }).filter(item => !isNaN(item.time))
  }

  const formatTimeForDisplay = (seconds) => {
    const minutes = Math.floor(seconds / 60)
    const secs = seconds % 60
    return `${minutes}:${secs.toString().padStart(2, '0')}`
  }

  const processMonthlyStats = () => {
    if (!data?.runs) return []
    
    const monthlyData = {}
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
    
    data.runs.forEach(run => {
      const date = new Date(run.date.split('/').reverse().join('-'))
      const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
      
      if (!monthlyData[monthKey]) {
        monthlyData[monthKey] = { month: monthKey, runs: 0, totalTime: 0 }
      }
      monthlyData[monthKey].runs += 1
      
      const timeParts = run.time.split(':')
      if (timeParts.length === 2) {
        monthlyData[monthKey].totalTime += parseInt(timeParts[0]) * 60 + parseInt(timeParts[1])
      }
    })
    
    return Object.values(monthlyData)
      .sort((a, b) => a.month.localeCompare(b.month))
      .slice(-12) // Last 12 months
      .map(month => {
        const [year, monthNum] = month.month.split('-')
        return {
          ...month,
          month: monthNames[parseInt(monthNum) - 1],
          avgTime: month.runs > 0 ? Math.round(month.totalTime / month.runs) : 0
        }
      })
  }

  const calculateStoryStats = () => {
    if (!data?.runs) return []
    
    const runs = data.runs
    const runs2025 = runs.filter(run => run.date.includes('2025'))
    const uniqueLocations2025 = new Set(runs2025.map(run => run.event))
    const locationArray = Array.from(uniqueLocations2025)
    let locationNames = locationArray.slice(0, 3).join(', ')
    if (locationArray.length > 3) {
      locationNames += ` & ${locationArray.length - 3} more`
    }
    
    // Season analysis
    const seasons = { Spring: 0, Summer: 0, Autumn: 0, Winter: 0 }
    runs2025.forEach(run => {
      const month = new Date(run.date.split('/').reverse().join('-')).getMonth()
      if (month >= 2 && month <= 4) seasons.Spring++
      else if (month >= 5 && month <= 7) seasons.Summer++
      else if (month >= 8 && month <= 10) seasons.Autumn++
      else seasons.Winter++
    })
    const busiestSeason = Object.entries(seasons).reduce((a, b) => a[1] > b[1] ? a : b)[0]
    
    // Fastest month
    const monthlyAvg = {}
    runs2025.forEach(run => {
      const date = new Date(run.date.split('/').reverse().join('-'))
      const monthKey = date.toLocaleString('default', { month: 'long' })
      const timeParts = run.time.split(':')
      const seconds = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1])
      
      if (!monthlyAvg[monthKey]) {
        monthlyAvg[monthKey] = { total: 0, count: 0 }
      }
      monthlyAvg[monthKey].total += seconds
      monthlyAvg[monthKey].count++
    })
    
    const fastestMonth = Object.entries(monthlyAvg)
      .map(([month, data]) => ({ 
        month, 
        avg: data.total / data.count,
        avgTime: formatTimeForDisplay(Math.round(data.total / data.count)),
        totalRuns: data.count
      }))
      .sort((a, b) => a.avg - b.avg)[0]
    
    // Most visited parkrun
    const eventCounts = {}
    runs2025.forEach(run => {
      eventCounts[run.event] = (eventCounts[run.event] || 0) + 1
    })
    const mostVisited = Object.entries(eventCounts)
      .sort((a, b) => b[1] - a[1])[0]
    
    // Total minutes and distance
    const totalSeconds = runs2025.reduce((total, run) => {
      const timeParts = run.time.split(':')
      return total + (parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]))
    }, 0)
    const totalMinutes = Math.round(totalSeconds / 60)
    const totalDistance = (runs2025.length * 5).toFixed(1) // 5km per run
    
    // Average age grade
    const avgAgeGrade = runs2025.reduce((total, run) => {
      const grade = parseFloat(run.ageGrade.replace('%', ''))
      return total + (isNaN(grade) ? 0 : grade)
    }, 0) / runs2025.length
    
    // Prepare chart data
    const timeData = processTimeData().slice(-10)
    const monthlyData = processMonthlyStats().slice(-12)
    
    return [
      { title: 'TOTAL PARKRUNS IN 2025', value: runs2025.length, subtitle: `at ${locationNames}`, type: 'stat' },
      { title: 'PERFORMANCE TREND', value: null, subtitle: 'Recent running times', type: 'chart', chartData: timeData, chartType: 'line' },
      { title: 'MONTHLY ACTIVITY', value: null, subtitle: 'Runs per month', type: 'chart', chartData: monthlyData, chartType: 'bar' },
      { title: 'BUSIEST SEASON', value: busiestSeason, subtitle: `${seasons[busiestSeason]} runs`, type: 'stat' },
      { title: 'FASTEST MONTH', value: fastestMonth?.month || 'N/A', subtitle: `avg ${fastestMonth?.avgTime || 'N/A'} ‚Ä¢ ${fastestMonth?.totalRuns || 0} runs`, type: 'stat' },
      { title: 'MOST VISITED PARKRUN', value: mostVisited[0], subtitle: `${mostVisited[1]} times`, type: 'stat' },
      { title: 'TOTAL MINUTES RUNNING', value: totalMinutes.toLocaleString(), subtitle: 'minutes spent', type: 'stat' },
      { title: 'AVERAGE AGE GRADE', value: `${avgAgeGrade.toFixed(1)}%`, subtitle: 'over the year', type: 'stat' },
      { title: 'TOTAL DISTANCE', value: totalDistance, subtitle: 'kilometers ran', type: 'stat' }
    ]
  }

  useEffect(() => {
    if (showStory && autoPlay) {
      const interval = setInterval(() => {
        nextSlide()
      }, 5000)
      return () => clearInterval(interval)
    }
  }, [showStory, currentSlide, autoPlay])

  useEffect(() => {
    const handleKeyPress = (e) => {
      if (showStory) {
        if (e.key === 'ArrowRight') {
          setAutoPlay(false)
          nextSlide()
        } else if (e.key === 'ArrowLeft') {
          setAutoPlay(false)
          prevSlide()
        }
      }
    }

    window.addEventListener('keydown', handleKeyPress)
    return () => window.removeEventListener('keydown', handleKeyPress)
  }, [showStory, currentSlide])

  const nextSlide = () => {
    const stats = calculateStoryStats()
    if (currentSlide < stats.length - 1) {
      setCurrentSlide(currentSlide + 1)
    } else {
      setCurrentSlide(0) // Loop back to start
    }
  }

  const prevSlide = () => {
    const stats = calculateStoryStats()
    if (currentSlide > 0) {
      setCurrentSlide(currentSlide - 1)
    } else {
      setCurrentSlide(stats.length - 1) // Loop to end
    }
  }

  const shareStory = () => {
    const stats = calculateStoryStats()
    const currentStat = stats[currentSlide]
    const text = `Parkrun Wrapped 2025: ${currentStat.title} - ${currentStat.value} ${currentStat.subtitle || ''}`
    if (navigator.share) {
      navigator.share({ text })
    } else {
      navigator.clipboard.writeText(text)
    }
  }

  return (
    <div className="app">
      <div className="header">
        <h1>üèÉ‚Äç‚ôÇÔ∏è Parkrun Wrapped 2025</h1>
        <p>Your parkrun journey visualized</p>
      </div>

      <div className="input-section">
        <input
          type="text"
          value={parkrunId}
          onChange={(e) => setParkrunId(e.target.value)}
          placeholder="Enter parkrun ID (e.g., 8604987)"
          className="id-input"
        />
        <button onClick={fetchData} disabled={loading} className="fetch-btn">
          {loading ? 'Loading...' : 'Get My Wrapped'}
        </button>
        {data && (
          <button onClick={() => setShowStory(!showStory)} className="story-btn">
            {showStory ? 'View Dashboard' : 'View Story'}
          </button>
        )}
      </div>

      {error && <div className="error">{error}</div>}

      {data && !showStory && (
        <div className="stats-container">
          <div className="stats-grid">
            <div className="stat-card">
              <h3>Total Runs</h3>
              <div className="stat-value">{data.statistics?.totalRuns || 0}</div>
            </div>
            <div className="stat-card">
              <h3>Best Time</h3>
              <div className="stat-value">{data.statistics?.bestTime || 'N/A'}</div>
            </div>
            <div className="stat-card">
              <h3>Unique Events</h3>
              <div className="stat-value">{data.statistics?.uniqueEvents || 0}</div>
            </div>
            <div className="stat-card">
              <h3>First Run</h3>
              <div className="stat-value">{data.statistics?.firstRun || 'N/A'}</div>
            </div>
          </div>

          <div className="chart-section">
            <h3>Recent Performance Trend</h3>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={processTimeData()}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="date" />
                <YAxis label={{ value: 'Time (seconds)', angle: -90, position: 'insideLeft' }} />
                <Tooltip formatter={(value) => [`${Math.floor(value/60)}:${String(value%60).padStart(2,'0')}`, 'Time']} />
                <Line type="monotone" dataKey="time" stroke="#8884d8" strokeWidth={2} />
              </LineChart>
            </ResponsiveContainer>
          </div>

          <div className="chart-section">
            <h3>Monthly Activity</h3>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={processMonthlyStats()}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="month" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="runs" fill="#82ca9d" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          <div className="recent-runs">
            <h3>Recent Runs</h3>
            <div className="runs-table">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Event</th>
                    <th>Position</th>
                    <th>Time</th>
                    <th>Age Grade</th>
                  </tr>
                </thead>
                <tbody>
                  {data.runs?.slice(0, 10).map((run, index) => (
                    <tr key={index}>
                      <td>{run.date}</td>
                      <td>{run.event}</td>
                      <td>{run.position}</td>
                      <td>{run.time}</td>
                      <td>{run.ageGrade}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      {data && showStory && (
        <div className="story-container">
          <div className="story-slide">
            <div className="progress-dots">
              {calculateStoryStats().map((_, index) => (
                <div
                  key={index}
                  className={`dot ${index === currentSlide ? 'active' : ''}`}
                  onClick={() => setCurrentSlide(index)}
                />
              ))}
            </div>
            
            <div className="story-card">
              <h2 className="story-title">
                {calculateStoryStats()[currentSlide]?.title}
              </h2>
              
              {calculateStoryStats()[currentSlide]?.type === 'chart' ? (
                <div className="story-chart">
                  {calculateStoryStats()[currentSlide]?.chartType === 'line' ? (
                    <ResponsiveContainer width="100%" height={250}>
                      <LineChart data={calculateStoryStats()[currentSlide]?.chartData}>
                        <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                        <XAxis dataKey="date" stroke="rgba(255,255,255,0.5)" />
                        <YAxis 
                          stroke="rgba(255,255,255,0.5)" 
                          tickFormatter={formatTimeForDisplay}
                          domain={['dataMin - 60', 'dataMax + 60']}
                        />
                        <Tooltip 
                          contentStyle={{ backgroundColor: 'rgba(0,0,0,0.8)', border: 'none', borderRadius: '8px' }}
                          formatter={(value) => [formatTimeForDisplay(value), 'Time']}
                        />
                        <Line type="monotone" dataKey="time" stroke="#ff8c00" strokeWidth={3} />
                      </LineChart>
                    </ResponsiveContainer>
                  ) : (
                    <ResponsiveContainer width="100%" height={250}>
                      <BarChart data={calculateStoryStats()[currentSlide]?.chartData}>
                        <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                        <XAxis 
                          dataKey="month" 
                          stroke="rgba(255,255,255,0.5)"
                          tick={{ fontSize: 12 }}
                        />
                        <YAxis stroke="rgba(255,255,255,0.5)" />
                        <Tooltip 
                          contentStyle={{ backgroundColor: 'rgba(0,0,0,0.8)', border: 'none', borderRadius: '8px' }}
                        />
                        <Bar dataKey="runs" fill="#ff8c00" />
                      </BarChart>
                    </ResponsiveContainer>
                  )}
                  <div className="story-subtitle">
                    {calculateStoryStats()[currentSlide]?.subtitle}
                  </div>
                </div>
              ) : (
                <>
                  <div className="story-value">
                    {calculateStoryStats()[currentSlide]?.value}
                  </div>
                  <div className="story-subtitle">
                    {calculateStoryStats()[currentSlide]?.subtitle}
                  </div>
                </>
              )}
            </div>
            
            <div className="story-controls">
              <button onClick={shareStory} className="control-btn share-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>
                </svg>
              </button>
              <button onClick={nextSlide} className="control-btn play-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default App
